!function(){"use strict";var e=angular.module("simpleMail.adminApp",["ngRoute","ngAnimate","ui.select","simpleMail.adminApp.controllers","simpleMail.services","simpleMail.directives","simpleMail.constants","angularFileUpload"]);e.config(["$routeProvider","paths",function(e,l){e.when("/headers",{templateUrl:l.PARTIALS_DIR()+"/admin/listHeaders.html",controller:"HeadersAdminController"}).when("/headers/:headerId/edit",{templateUrl:l.PARTIALS_DIR()+"/admin/editHeader.html",controller:"HeaderAdminController"}).when("/headers/new",{templateUrl:l.PARTIALS_DIR()+"/admin/editHeader.html",controller:"HeaderAdminController"}).when("/messages",{templateUrl:l.PARTIALS_DIR()+"/admin/listMessages.html",controller:"MessagesAdminController"}).otherwise({redirectTo:"/"})}])}();
!function(){"use strict";var e=angular.module("simpleMail.adminApp.controllers",[]);e.config(["$httpProvider",function(e){e.defaults.headers.common["X-Requested-With"]="XMLHttpRequest"}]),e.controller("HeadersAdminController",["$scope","$http","$q","civiApiServices","loggingServices","notificationServices",function(e,r,t,a,n,i){e.constants={ENTITY_NAME:"SimpleMailHeader"},e.headers={},a.get(e.constants.ENTITY_NAME).then(function(r){return r.data.is_error?t.reject(r):(e.headers=r.data.values,n.createLog("Headers received",e.headers),!0)}).catch(function(e){n.createLog("Failed to retrieve headers",e)}),e.deleteHeader=function(r){var s=e.headers[r];a.remove(e.constants.ENTITY_NAME,s).then(function(e){return n.createLog("Delete message response",e),e.data.is_error?t.reject(e):!0}).then(function(){e.headers.splice(r,1),i.success("Header deleted")}).catch(function(r){i.error("Failed to delete header",r.data.error_message),e.errorMessage=r.data.error_message})}}]),e.controller("HeaderAdminController",["$scope","$http","$q","$fileUploader","civiApiServices","loggingServices","notificationServices","$routeParams","$location","utilityServices",function(e,r,t,a,n,i,s,o,d,c){e.header={},e.models={},e.filters=[],e.constants={ENTITY_NAME:"SimpleMailHeader"};var l=e.imageUploader=a.create({scope:e,url:"/civicrm/ajax/rest?entity=SimpleMailHeader&action=uploadimage&json=1&sequential=1",autoUpload:!0,headers:{"X-Requested-with":"XMLHttpRequest"},filters:[function(){return console.info("filter1"),!0}]});l.bind("beforeupload",function(r,t){switch(console.info("Before upload",t),t.field){case"image":e.header.uploadingField="image",t.formData.push({field:"image"});break;case"logo_image":e.header.uploadingField="logo_image",t.formData.push({field:"logo_image"})}}),l.bind("success",function(r,t,a,n){console.info("Success",t,a,n),e.remove(a.field),e.header[a.field]=n.values[0].imageFileName,e.header[a.field+"_url"]=n.values[0].imageUrl,e.header.uploadingField=null,s.success("Image uploaded")}),l.bind("error",function(e,r,t,a){console.info("Error",r,t,a)}),l.bind("complete",function(e,r,t,a){console.info("Complete",r,t,a)}),l.bind("progressall",function(e,r){console.info("Total progress: "+r)}),e.cancel=function(){e.header.id||(e.header.image&&e.remove("image"),e.header.logo_image&&e.remove("logo_image")),e.redirectToListing()},e.remove=function(r){var t=e.header[r];t&&n.post("SimpleMailHeader",{field:r,fileName:t},"deleteimage").success(function(e){e.is_error?s.error("Failed to delete the image",e.error_message):s.success("Image deleted successfully")}),e.header[r]=e.header[r+"_url"]=void 0},o.headerId&&n.get(e.constants.ENTITY_NAME,{id:o.headerId}).then(function(r){return i.createLog("Header retrieved",r),r.data.is_error?t.reject(r):(e.header=r.data.values[0],!0)}).then(function(){return n.get("SimpleMailHeaderFilter",{header_id:e.header.id}).then(function(r){return console.log("Filters retrieved",r),r.data.is_error?t.reject(r):(e.header.filterIds=[],angular.forEach(r.data.values,function(r){e.header.filterIds.push(r.entity_id)}),!0)})}).catch(function(r){s.error("Failed to retrieve the header",r.data.error_message),e.redirectToListing()}),n.getValue("OptionGroup",{name:"sm_header_filter_options","return":"id"}).then(function(e){return i.createLog("Option Group ID retrieved for filters",e),e.data.is_error?t.reject(e):+e.data.result}).then(function(e){return console.log("Option Group ID",e),n.get("OptionValue",{option_group_id:e})}).then(function(r){console.log("Option values retrieved",r),e.filters=r.data.values}).catch(function(e){console.log("Failed to retrieve filters",e)}),e.redirectToListing=function(){d.path("/headers")},e.validateHeader=function(e){var r=!1;return e.$error.required&&(r=!0),r},e.createOrUpdateHeader=function(r){return e.header.submitted=!0,e.validateHeader(r)?void s.error("Please fix the errors on the page"):void(e.header.id?n.update(e.constants.ENTITY_NAME,e.header).then(function(e){i.createLog("Update header response",e),e.data.is_error&&t.reject(e),s.success("Header updated")}).then(function(){return n.get("SimpleMailHeaderFilter",{header_id:+e.header.id}).then(function(r){if(console.log("Filters retrieved",r),r.data.is_error)return t.reject(r);var a=[],n=e.header.filterIds;angular.forEach(r.data.values,function(e){a.push(e.entity_id)}),console.log("Old filters",a),console.log("New filters",n);var i=c.arrayDiff(a,n),s=c.arrayDiff(n,a);return console.log("Removed filters",i),console.log("Added filters",s),{added:s,removed:i,filters:r}}).then(function(r){for(var a=[],i=0,s=r.added.length;s>i;i++){var o={header_id:e.header.id,entity_table:"civicrm_option_value",entity_id:+r.added[i]},d=n.create("SimpleMailHeaderFilter",o).then(function(e){return e.data.is_error?t.reject(e):(console.log("Filter added",e),!0)}).catch(function(e){return t.reject(e)});a.push(d)}return t.all(a).then(function(){return r}).catch(function(e){return t.reject(e)})}).then(function(e){for(var r=[],a=0,i=e.removed.length;i>a;a++){var s=null;angular.forEach(e.filters.data.values,function(r){r.entity_id===e.removed[a]&&(s=+r.id)});var o=n.remove("SimpleMailHeaderFilter",{id:s}).then(function(e){return e.data.is_error?t.reject(e):(console.log("Filter deleted",e),!0)}).catch(function(e){return t.reject(e)});r.push(o)}return t.all(r)}).catch(function(e){return t.reject(e)})}).then(e.redirectToListing).catch(function(e){s.error("Failed to update header",e.data.error_message)}):n.create(e.constants.ENTITY_NAME,e.header).success(function(r){i.createLog("Save header response",r),r.error_message?s.error("Failed to add header",r.error_message):(s.success("Header added"),e.redirectToListing())}))}}]),e.controller("MessagesAdminController",["$scope","$http","$q","civiApiServices","loggingServices","notificationServices",function(e,r,t,a,n,i){e.$on("$viewContentLoaded",function(){cj("#crm-container textarea.huge:not(.textarea-processed), #crm-container textarea.form-textarea:not(.textarea-processed)").each(function(){var e=cj(this);0==e.parents("div.civicrm-drupal-wysiwyg").length&&e.TextAreaResizer()})}),e.constants={ENTITY_NAME:"SimpleMailMessage"},e.messages=[],e.newMessage={is_active:"1"},a.get(e.constants.ENTITY_NAME).then(function(r){return r.data.is_error?t.reject(r):(e.messages=r.data.values,n.createLog("Messages retrieved",e.messages),!0)}).catch(function(e){n.createLog("Failed to retrieve messages",e)}),e.clearNewMessageForm=function(){e.newMessage={}},e.enableAddingMessage=function(){e.newMessage.editing=!0},e.disableAddingMessage=function(){e.newMessage.editing=!1,e.clearNewMessageForm()},e.enableEditingMessage=function(r){e.messages[r].editing=!0},e.disableEditingMessage=function(r){e.messages[r].editing=!1},e.createMessage=function(){var r=e.newMessage;a.create(e.constants.ENTITY_NAME,r).then(function(e){return n.createLog("Create message response",e),e.data.is_error?t.reject(e):(i.success("Message added"),e.data.values[0])}).then(function(r){e.messages.push(r),e.disableAddingMessage()}).catch(function(r){n.createLog("Failed to add message",r.data.error_message),e.errorMessage=r.data.error_message})},e.updateMessage=function(r){var s=e.messages[r];a.update(e.constants.ENTITY_NAME,s).then(function(e){return n.createLog("Update message response",e),e.is_error?t.reject(e):(i.success("Message updated"),!0)}).then(function(){e.disableEditingMessage(r)}).catch(function(r){i.error("Failed to update message",r.data.error_message),e.errorMessage=r.data.error_message})},e.deleteMessage=function(r){var n=e.messages[r];a.remove(e.constants.ENTITY_NAME,n).then(function(e){return console.log(e),e.is_error?t.reject(e):(i.success("Message deleted"),!0)}).then(function(){e.messages.splice(r,1)}).catch(function(r){console.log("Failed to update the record:",r.error_message),e.errorMessage=r.error_message})}}])}();
!function(){"use strict";var e=angular.module("simpleMail.app",["ngRoute","ngAnimate","ui.select","ngQuickDate","simpleMail.app.controllers","simpleMail.services","simpleMail.directives","simpleMail.constants","simpleMail.filters"]);e.config(["$routeProvider","paths","ngQuickDateDefaultsProvider",function(e,l,i){i.set({parseDateFunction:function(e){var l=Date.create(e);return l.isValid()?l:null}}),e.when("/mailings",{templateUrl:l.PARTIALS_DIR()+"/wizard/listMailings.html",controller:"MailingsController"}).when("/mailings/:mailingId",{redirectTo:"/mailings/:mailingId/steps/1"}).when("/mailings/:mailingId/steps",{redirectTo:"/mailings/:mailingId/steps/1"}).when("/mailings/:mailingId/steps/1",{templateUrl:l.PARTIALS_DIR()+"/wizard/steps/steps.html",controller:"CreateMailingController"}).when("/mailings/:mailingId/steps/2",{templateUrl:l.PARTIALS_DIR()+"/wizard/steps/steps.html",controller:"ComposeMailingController"}).when("/steps/2",{templateUrl:l.PARTIALS_DIR()+"/wizard/steps/steps.html",controller:"ComposeMailingController"}).when("/mailings/:mailingId/steps/3",{templateUrl:l.PARTIALS_DIR()+"/wizard/steps/steps.html",controller:"TestMailingController"}).when("/mailings/:mailingId/steps/4",{templateUrl:l.PARTIALS_DIR()+"/wizard/steps/steps.html",controller:"ScheduleAndSendController"}).otherwise({redirectTo:"/mailings"})}])}();
!function(){"use strict";var t=angular.module("simpleMail.constants",[]);t.constant("paths",{EXT_DIR:"/sites/all/extensions/uk.co.compucorp.civicrm.simplemail",TEMPLATES_DIR:function(){return this.EXT_DIR+"/js/dist/templates"},PARTIALS_DIR:function(){return this.EXT_DIR+"/partials"}})}();
!function(){"use strict";var e=angular.module("simpleMail.app.controllers",[]);e.config(["$httpProvider",function(e){e.defaults.headers.common["X-Requested-With"]="XMLHttpRequest"}]),e.controller("MailingsController",["$scope","$http","$q","civiApiServices","loggingServices","notificationServices","$filter",function(e,t,i,n,a,l,o){e.constants={ENTITY_NAME:"SimpleMail",DRAFT:"Not Scheduled",SCHEDULED:"Scheduled",SENT:"Complete",CANCELLED:"Canceled"},e.showFilters=!0,e.models={},e.models.mailingsLoaded=!1,e.mailingFilters={status:{},creator:"all"},e.filteredMailings=[],e.mailingFilters.status[e.constants.DRAFT]=!0,e.mailingFilters.status[e.constants.SCHEDULED]=!0,e.mailingFilters.status[e.constants.SENT]=!0,e.mailingFilters.status[e.constants.CANCELLED]=!0,n.get(e.constants.ENTITY_NAME).then(function(t){a.createLog("Mailings retrieved",t),e.mailings=t.data.values;var i=o("extractColumn")(e.mailings,{id:"created_id",name:"sort_name"});e.models.creators=o("unique")(i,"id"),e.models.creators.unshift({id:"all",name:"All"});var n=o("filter")(e.models.creators,{id:t.data.userId});e.mailingFilters.creator=n.length?t.data.userId:"all"}).finally(function(){e.models.mailingsLoaded=!0}).catch(function(e){console.log("Failed to retrieve mailing",e)}),e.deleteMailing=function(t){if(t.hasOwnProperty("_internal")||(t._internal={}),t._internal.deleteEnabled!==!1){t._internal.deleteEnabled=!1;var a=e.mailings.indexOf(t);-1!==a&&n.remove("SimpleMail",t).then(function(n){return n.data.is_error?i.reject(n):(l.success("Mailing deleted"),e.mailings.splice(a,1),void(t._internal.deleteEnabled=!0))}).catch(function(e){l.error("Failed to delete the mailing",e.data.error_message),console.log("Failed to delete the mailing",e),t._internal.deleteEnabled=!0})}},e.cancelMailing=function(t){if(t.hasOwnProperty("_internal")||(t._internal={}),t._internal.cancelEnabled!==!1){t._internal.cancelEnabled=!1;var a=e.mailings.indexOf(t);-1!==a&&n.post("SimpleMail",t,"cancelmassemail").then(function(e){return e.data.is_error?i.reject(e):(l.success("Mailing cancelled"),t.status="Canceled",void(t._internal.cancelEnabled=!0))}).catch(function(e){l.error("Failed to cancel the mailing"),console.log("Failed to cancel the mailing",e),t._internal.cancelEnabled=!0})}}}]),e.controller("CreateMailingController",["$scope","$http","$routeParams","$location","$filter","civiApiServices","loggingServices","notificationServices","paths","mailingServices",function(e,t,i,n,a,l,o,r,s,c){c.initStep({step:1,scope:e}),e.constants={ENTITY_NAME:"Group"},e.mailing={},e.groups=[],c.getMailing().then(function(t){e.mailing=t}),l.get(e.constants.ENTITY_NAME).success(function(t){o.createLog("Groups retrieved",t),e.groups=a("filter")(t.values,{is_hidden:0})})}]),e.controller("ComposeMailingController",["$scope","$timeout","$http","$routeParams","$location","$q","civiApiServices","loggingServices","notificationServices","paths","mailingServices","itemFromCollectionFilter",function(e,t,i,n,a,l,o,r,s,c,d,g){e.models={selectedMessage:{},headersLoaded:!1},e.headers=e.messages=[],d.initStep({step:2,scope:e}),e.constants={ENTITY_NAME:"Group"},e.mailing={},e.$watch("mailing.message_id",function(t,i){if(i!==t){e.mailing.message_id=t;var n=g(e.messages,"id",e.mailing.message_id),a=n.item;null!==a&&a.hasOwnProperty("text")&&(e.models.selectedMessage.text=a.text)}}),o.getValue("OptionGroup",{name:"from_email_address","return":"id"}).then(function(e){return r.createLog("From-email address option response",e),e.data.is_error?l.reject(e):e.data.result}).then(function(t){return o.get("OptionValue",{option_group_id:t}).then(function(t){r.createLog("From-email address group options response",t),e.fromEmailOptionValues=t.data.values})}).catch(function(){s.error("Failed to retrieve from-email addresses")}),o.get("SimpleMailHeader",{withFilters:!0},"get").then(function(t){return console.log("Headers retrieved",t),t.data.is_error?l.reject(t):void(e.headers=t.data.values)}).then(function(){e.models.headersLoaded=!0}).catch(function(e){console.log("Failed to retrieve headers",e)}),o.getValue("OptionGroup",{name:"sm_header_filter_options","return":"id"}).then(function(e){return e.data.is_error?l.reject(e):(console.log("Option group for filters retrieved",e),+e.data.result)}).then(function(t){o.get("OptionValue",{option_group_id:t,is_active:"1"}).then(function(t){return t.data.is_error?l.reject(t):(console.log("Filter values retrieved",t),e.filters=t.data.values,e.filters.unshift({id:"all",label:"All"}),!0)})}).catch(function(e){console.log("Failed to retrieve filter values",e)}),d.getMailing().then(function(t){e.mailing=t}).then(function(){return o.get("SimpleMailMessage",{is_active:1}).success(function(t){r.createLog("Messages retrieved",t),e.messages=t.values;var i=g(e.messages,"id",e.mailing.message_id),n=i.item;null!==n&&n.hasOwnProperty("text")&&(e.models.selectedMessage.text=n.text)})}).catch(function(e){console.log("Failed to retrieve the mailing",e)})}]),e.controller("TestMailingController",["$scope","$http","$routeParams","$location","$filter","civiApiServices","loggingServices","notificationServices","mailingServices",function(e,t,i,n,a,l,o,r,s){s.initStep({step:3,scope:e}),e.constants={ENTITY_NAME:"Group"},e.mailing={},e.groups=[],e.constants={ENTITY_NAME:"Group"},e.models={emailHtml:""},s.getMailing().then(function(t){e.mailing=t}),l.get(e.constants.ENTITY_NAME).success(function(t){o.createLog("Groups retrieved",t),e.groups=a("filter")(t.values,{is_hidden:0})})}]),e.controller("ScheduleAndSendController",["$scope","$http","$routeParams","$location","civiApiServices","loggingServices","notificationServices","mailingServices",function(e,t,i,n,a,l,o,r){r.initStep({step:4,scope:e}),e.constants={ENTITY_NAME:"Group"},e.mailing={},r.getMailing().then(function(t){e.mailing=t}),e.$on("$includeContentLoaded",function(){cj("#datepicker").datepicker()}),e.constants={ENTITY_NAME:"Group"}}])}();
!function(){"use strict";var e=["paths",function(e){function t(e){e.$watch(function(){return e.config.required},function(t){e.isRequired=-1!==["0","1"].indexOf(t)?+t?!0:!1:-1!==["false","true"].indexOf(t)?"true"===t:t})}return{restrict:"AE",scope:{model:"=",uploader:"=",config:"=",remove:"&onRemove"},templateUrl:e.TEMPLATES_DIR()+"/image-uploader.html",link:t}}],t=["paths","$timeout","$rootScope","itemFromCollectionFilter","headersForSelectedFilterFilter",function(e,t,n,i,l){function o(e,n){e.selectedIndex=null,e.selectedItem=null,e.filteredItems=[],e.$watchCollection(function(){return e.items},function(t){console.log(t),t.length&&(e.selectedFilterId="all",console.log("Selected item",e.selectedItem))}),e.$watch(function(){return e.selectedIndex},function(t){null!==t&&(e.selectedItemId=e.filteredItems[e.selectedIndex].id,console.log("Item ID",e.selectedItemId))}),e.$watch(function(){return e.selectedItemId},function(t){t&&e.updateSelection()}),e.$watch(function(){return e.selectedFilterId},function(){console.log("--- Filter changed ---"),e.filterItems(),e.updateSelection()},!0),e.filterItems=function(){e.filteredItems=l(e.items,e.selectedFilterId),t(function(){e.setWidth()},200)},e.selectImage=function(t){console.log("Image selected with index",t),e.selectedIndex=t},e.updateSelection=function(){var t=i(e.filteredItems,"id",e.selectedItemId);e.selectedIndex=t.index},e.resetWidth=function(){n.find("ul").width("100%")},e.setWidth=function(){var e=n.find("ul").find("img"),t=0,i=0;if(e.length){for(var l=0;l<e.length;l++)i=$(e[l]).outerWidth(!0),t+=i,console.log(i);t+=.005*t}else t="100%";console.log("Total length",t),n.find("ul").width(t)}}return{restrict:"AE",scope:{items:"=",selectedFilterId:"=",selectedItemId:"=",itemsLoaded:"="},templateUrl:e.TEMPLATES_DIR()+"/simple-image-carousel.html",link:o}}],n=[function(){function e(e,t,n,i){var l=CKEDITOR.replace(t[0],{enterMode:CKEDITOR.ENTER_BR});i&&(l.on("pasteState",function(){e.$apply(function(){i.$setViewValue(l.getData())})}),i.$render=function(){l.setData(i.$viewValue)})}return{require:"?ngModel",restrict:"A",link:e}}],i=[function(){function e(e,t,n){e.$watch(n.emailContent,function(e,n){var i=e?e:n;if(i){var l=t[0],o=null;l.contentDocument?o=l.contentDocument:l.contentWindow&&(o=l.contentWindow.document),o.open(),o.writeln(i),o.close()}})}return{restrict:"A",link:e}}],l=["paths",function(e){return{restrict:"AE",scope:{mailing:"=",constants:"=statusConstants","delete":"&onDelete",cancel:"&onCancel"},templateUrl:e.TEMPLATES_DIR()+"/action-buttons.html"}}];angular.module("simpleMail.directives",[]).directive("smImageUploader",e).directive("smImageCarousel",t).directive("smCkEditor",n).directive("smEmailPreviewer",i).directive("smMailingActionButtons",l)}();
!function(){"use strict";var r=angular.module("simpleMail.filters",[]);r.filter("itemFromCollection",[function(){return function(r,n,t){var e={item:null,index:null};if(angular.isUndefined(r)||angular.isUndefined(t))return e;for(var u=null,i=0,a=r.length;a>i;i++)u=r[i],angular.isObject(u)&&u.hasOwnProperty(n)&&u[n]===t&&(e.item=u,e.index=i);return e}}]),r.filter("filterMailings",["$filter",function(r){return function(n,t){if(!angular.isArray(n))return!1;if(!angular.isObject(t))return n;var e=n;return t.hasOwnProperty("status")&&t.status&&(e=r("filterMailingsByStatus")(n,t.status)),t.hasOwnProperty("creator")&&t.creator&&(e=r("filterMailingsByCreator")(e,t.creator)),e}}]),r.filter("filterMailingsByStatus",[function(){return function(r,n){var t=[];angular.forEach(n,function(r,n){r&&t.push(n)});for(var e=null,u=[],i=0,a=r.length;a>i;i++)e=r[i],e.hasOwnProperty("status")&&-1!==t.indexOf(e.status)&&u.push(e);return u}}]),r.filter("filterMailingsByCreator",[function(){return function(r,n){if("all"===n)return r;for(var t=[],e=null,u=0,i=r.length;i>u;u++)e=r[u],e.hasOwnProperty("created_id")&&e.created_id===n&&t.push(e);return t}}]),r.filter("headersForSelectedFilter",["uniqueFilter",function(r){return function(n,t){if("all"===t)return r(n,"id");if(!t)return n;var e=[];return angular.forEach(n,function(r){r.entity_id===t&&(console.log("Value",r),e.push(r))}),e}}]),r.filter("unique",[function(){return function(r,n){var t=[],e=[];return n=n||0,angular.forEach(r,function(r){var u=null;angular.isObject(r)&&r.hasOwnProperty(n)?u=r[n]:angular.isString(r)&&(u=r),-1===t.indexOf(u)&&(t.push(u),e.push(r))}),e}}]),r.filter("extractColumn",[function(){return function(r,n){var t=[];return angular.isObject(r)&&angular.isObject(n)&&angular.forEach(r,function(r){var e={};angular.forEach(n,function(n,t){angular.isObject(r)&&r.hasOwnProperty(n)&&r[n]&&(e[t]=r[n])}),t.push(e)}),t}}])}();
!function(){"use strict";var t=angular.module("simpleMail.services",[]);t.factory("utilityServices",[function(){return{arrayDiff:function(t,i){for(var e=[],n=0,s=t.length;s>n;n++)-1===i.indexOf(t[n])&&e.push(t[n]);return e}}}]),t.factory("mailingServices",["$location","$routeParams","$q","civiApiServices","paths","utilityServices","notificationServices",function(t,i,e,n,s,o,r){var a={ENTITY:"SimpleMail"},c={FIRST:1,LAST:4},u="/mailings",l=function(t){return u+"/"+t.mailingId+"/steps/"+t.step},g=function(t){return s.PARTIALS_DIR()+"/wizard/steps/step-"+t+".html"},f=function(){t.path(u)};return{config:{mailingId:null,mailing:null,step:c.FIRST},initStep:function(t){return this.setStep(t.step).setScope(t.scope),this.setupMailing().setupButtons().setupPartials(),this},setupMailing:function(){var t=i.mailingId,e="new"===t?{}:this.get(t).then(function(t){return t}).catch(function(t){return console.log("Failed to retrieve mailing",t),{}});return this.setMailingId(t),this.setMailing(e),this},setScope:function(t){return this.config.scope=t,this},getScope:function(){return this.config.scope},setupPartials:function(){return this.getScope().partial=g(this.getStep()),this},getMailingId:function(){return this.config.mailingId},setMailingId:function(t){this.config.mailingId=+t},getMailing:function(){return e.when(this.config.mailing)},setMailing:function(t){this.config.mailing=t},get:function(t){return n.get(a.ENTITY,{id:t}).then(function(t){return t.data.is_error?e.reject(t):(console.log("Mailing retrieved",t),t.data.values[0])})},submitMassEmail:function(){this.getMailing().then(function(t){return t.send_immediately&&(t.scheduled_date=Date.create().format("{yyyy}-{{MM}}-{{dd}} {{HH}}:{{mm}}:{{ss}}")),t}).then(function(t){return n.post(a.ENTITY,t,"submitmassemail")}).then(function(){r.success("Mailing submitted for mass emailing"),f()}).catch(function(t){return r.error("Oops! Failed to submit the mailing for mass emailing"),console.log("Something went wrong when trying to submit for mass emailing",t),e.reject(t)}),this.saveProgress().then()},saveProgress:function(){var t=this;return this.getMailing().then(function(t){return n.create(a.ENTITY,t)}).then(function(i){return i.data.is_error?e.reject(i):(console.log("Mailing saved",i),r.success("Mailing saved"),void(isNaN(t.getMailingId())&&t.setMailingId(+i.data.values[0].id)))}).catch(function(t){return r.error("Failed to save the mailing"),console.log("Failed to save the mailing",t),e.reject(t)})},submitTestEmail:function(){this.getMailing().then(function(t){if(!t.crm_mailing_id)return void r.error("Cannot send test email as CiviCRM mailing does not exist for this");r.info("Sending test email");var i={crmMailingId:t.crm_mailing_id,groupId:t.testRecipientGroupId};return n.post("SimpleMail",i,"sendtestemail")}).then(function(t){console.log(t),r.success("Test email send")}).catch(function(t){r.error("Failed to send test email"),console.log("Failed to send test email",t)})},setStep:function(t){return this.config.step=t,this},prevStep:function(){this.proceedToStep(this.config.step-1)},nextStep:function(){this.proceedToStep(this.config.step+1)},proceedToStep:function(t){var i=this;this.saveProgress().then(function(){i.redirectToStep(t)}).catch(function(t){console.log("Failed to save progress",t)})},redirectToStep:function(i){t.path(l({mailingId:this.getMailingId(),step:i}))},cancel:function(){t.path(u)},getStep:function(){return this.config.step},showPrevStepLink:function(){return this.getStep()!==c.FIRST},showNextStepLink:function(){return this.getStep()!==c.LAST},setupButtons:function(){var t=this,i=this.getScope();return i.showPrevStepLink=this.showPrevStepLink(),i.showNextStepLink=this.showNextStepLink(),this.getStep()===c.LAST&&(i.showSubmitMassEmailLink=!0,this.getMailing().then(function(t){t.crm_mailing_id&&t.send_on&&(i.canUpdate=!0)})),i.nextStep=function(){t.setMailing(i.mailing),t.nextStep()},i.prevStep=function(){t.setMailing(i.mailing),t.prevStep()},i.submitMassEmail=function(){t.setMailing(i.mailing),t.submitMassEmail()},i.submitTestEmail=function(){t.submitTestEmail()},i.saveAndContinueLater=function(){t.setMailing(i.mailing),t.saveProgress().then(function(){r.success("Mailing saved"),f()}).catch(function(t){r.error("Failed to save mailing"),console.log("Failed to save progress",t)})},i.cancel=function(){t.cancel()},this}}}]),t.factory("notificationServices",["loggingServices",function(t){var i=!0,e=!0,n={SUCCESS:"success",ERROR:"error",INFO:"info",ALERT:"alert"};return{alert:function(t,i){this._createCrmNotication(t,i,n.ALERT)},success:function(t,i){this._createCrmNotication(t,i,n.SUCCESS)},info:function(t,i){this._createCrmNotication(t,i,n.INFO)},error:function(t,i){this._createCrmNotication(t,i,n.ERROR)},_createCrmNotication:function(n,s,o){i&&(s=s||"",CRM.alert(s,n,o),e&&t.createLog("("+o.toUpperCase()+") "+n,s))}}}]),t.factory("loggingServices",function(){var t=!0;return{createLog:function(i,e){t&&(e?console.log(i+":",e):console.log(i))}}}),t.factory("civiApiServices",["$http",function(t){return{get:function(t,i){var e=i||{};return this.post(t,e,"get")},getValue:function(t,i){var e=i||{};return this.post(t,e,"getValue")},create:function(t,i){return this.post(t,i,"create")},update:function(t,i){return this.post(t,i,"create")},remove:function(t,i){return this.post(t,i,"delete")},post:function(i,e,n){e.entity=i,e.action=n,e.sequential=1,e.json=1;var s=jQuery.param(e);return t({method:"POST",url:"/civicrm/ajax/rest",data:s,headers:{"Content-Type":"application/x-www-form-urlencoded"}})}}}])}();